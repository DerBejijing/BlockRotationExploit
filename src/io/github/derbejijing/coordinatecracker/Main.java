 package io.github.derbejijing.coordinatecracker;

import java.awt.EventQueue;
import java.awt.Image;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

import javax.swing.JFrame;
import javax.swing.JPanel;
import javax.swing.border.BevelBorder;
import javax.swing.event.ChangeEvent;
import javax.swing.event.ChangeListener;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;

import io.github.derbejijing.coordinatecracker.cracker.CoordinateBruteforcer;
import io.github.derbejijing.coordinatecracker.data.EnumMCVersion;
import io.github.derbejijing.coordinatecracker.data.EnumRotation;
import io.github.derbejijing.coordinatecracker.data.PatternRelative;
import io.github.derbejijing.coordinatecracker.gui.ErrorPopup;
import io.github.derbejijing.coordinatecracker.math.Matrix3;
import io.github.derbejijing.coordinatecracker.math.Vector2;
import io.github.derbejijing.coordinatecracker.math.Vector3;
import io.github.derbejijing.coordinatecracker.utils.MathHelper;

import javax.swing.JButton;
import javax.swing.JSpinner;
import javax.swing.SpinnerNumberModel;
import javax.swing.JLabel;
import javax.swing.JComboBox;
import javax.swing.DefaultComboBoxModel;
import javax.swing.ImageIcon;
import javax.swing.JTextField;
import javax.swing.SpinnerModel;
import java.awt.Color;

public class Main implements ActionListener{

	private static Main instance;
	
	private JFrame frame;
	
	private List<JButton> fieldButtons;
	
	private JButton btnStartCracking;
	private JButton btnRotateRight;
	private JButton btnSetTextured;
	
	private JTextField saveResultsField;
	
	private JButton btnApply;
	
	private JSpinner ySpinnerMin;
	private JSpinner ySpinnerMax;
	
	private JLabel lblProgress;
	private JLabel lblTotalMatches;
	private JLabel lblEstimatetTime;
	
	private Vector2 activeField;
	
	private Matrix3 pattern;
	
	private boolean crackerRunning;
	private boolean crackerEnabled;
	private boolean validYMin;
	private boolean validYMax;
	private boolean validRadius;
	
	private int currentLayer;
	
	private ImageIcon icon_0;
	private ImageIcon icon_1;
	private ImageIcon icon_2;
	private ImageIcon icon_3;
	
	private int yMin;
	private int yMax;
	private int radius;
	
	private int threadCount;
	
	private String saveResultsPath;
	
	private CoordinateBruteforcer cb;
	
	private EnumMCVersion mcVersion;
	
	private EnumRotation rotation;
	private JTextField radiusTextField;
	
	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					Main window = new Main();
					window.frame.setVisible(true);
				} catch (Exception e) {
					new ErrorPopup().showPopup();
				}
			}
		});
	}

	public Main() {
		initialize();
	}

	@SuppressWarnings({ "unchecked", "rawtypes" })
	private void initialize() {
		instance = this;
		
		this.fieldButtons = new ArrayList<>();
		this.activeField = new Vector2(3, 3);
		this.pattern = new Matrix3(new Vector3(7, 7, 7), new Vector3(4, 4, 4));
		
		for(int x = 0; x < 7; x++) {
			for(int y = 0; y < 7; y++) {
				for(int z = 0; z < 7; z++) {
					this.pattern.setValue(new Vector3(x, y, z), 4);
				}
			}
		}
		
		this.currentLayer = 1;
		
		this.icon_0 = new ImageIcon(getClass().getClassLoader().getResource("io/github/derbejijing/coordinatecracker/icons/grass_top_0.png"));
		this.icon_1 = new ImageIcon(getClass().getClassLoader().getResource("io/github/derbejijing/coordinatecracker/icons/grass_top_1.png"));
		this.icon_2 = new ImageIcon(getClass().getClassLoader().getResource("io/github/derbejijing/coordinatecracker/icons/grass_top_2.png"));
		this.icon_3 = new ImageIcon(getClass().getClassLoader().getResource("io/github/derbejijing/coordinatecracker/icons/grass_top_3.png"));
		
		this.cb = null;
		
		this.crackerEnabled = true;
		
		this.yMin = 0;
		this.yMax = 256;
		this.radius = 100;
		
		this.validYMin = true;
		this.validYMax = true;
		this.validRadius = true;
		
		this.threadCount = 1;
		
		this.rotation = EnumRotation.R_ALL;
		
		frame = new JFrame();
		frame.setBounds(100, 100, 801, 609);
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		frame.getContentPane().setLayout(null);
		frame.setResizable(false);
		
		JPanel panel = new JPanel();
		panel.setBounds(12, 0, 777, 567);
		frame.getContentPane().add(panel);
		panel.setLayout(null);
		
		JPanel panel_1 = new JPanel();
		panel_1.setBorder(new BevelBorder(BevelBorder.LOWERED, null, null, null, null));
		panel_1.setBounds(12, 12, 465, 543);
		panel.add(panel_1);
		panel_1.setLayout(null);
		
		SpinnerModel values = new SpinnerNumberModel(1, 1, 7, 1);
		JSpinner spinner = new JSpinner(values);
		spinner.setBounds(66, 509, 79, 20);
		spinner.addChangeListener(new ChangeListener() {
			@Override
			public void stateChanged(ChangeEvent e) {
				currentLayer = (int) spinner.getValue();
				System.out.println("Rendering");
				
				renderLayer(currentLayer);
			}
		});
		panel_1.add(spinner);
		
		JLabel lblLayer = new JLabel("Layer:");
		lblLayer.setBounds(10, 511, 68, 15);
		panel_1.add(lblLayer);
		
		btnRotateRight = new JButton("Rotate tile");
		btnRotateRight.setBounds(165, 481, 150, 25);
		btnRotateRight.addActionListener(this);
		panel_1.add(btnRotateRight);
		
		JPanel panel_4 = new JPanel();
		panel_4.setBorder(new BevelBorder(BevelBorder.LOWERED, null, null, null, null));
		panel_4.setBounds(63, 51, 350, 350);
		panel_1.add(panel_4);
		panel_4.setLayout(null);
		
		btnSetTextured = new JButton("Set Textured");
		btnSetTextured.setBounds(12, 481, 150, 25);
		btnSetTextured.addActionListener(this);
		panel_1.add(btnSetTextured);
		
		JLabel lblDirectionIndicator = new JLabel("West");
		lblDirectionIndicator.setBounds(215, 24, 40, 15);
		panel_1.add(lblDirectionIndicator);
		
		for(int x = 0; x < 350; x += 50) {
			for(int y = 0; y < 350; y += 50) {
				JButton button = new JButton("");
				button.setBackground(Color.GRAY);
				button.setBounds(x, y, 50, 50);
				button.addActionListener(this);
				this.fieldButtons.add(button);
				panel_4.add(button);
			}
		}
		
		JPanel panel_2 = new JPanel();
		panel_2.setBorder(new BevelBorder(BevelBorder.LOWERED, null, null, null, null));
		panel_2.setBounds(488, 12, 277, 543);
		panel.add(panel_2);
		panel_2.setLayout(null);
		
		JLabel lblOptions = new JLabel("Options");
		lblOptions.setBounds(12, 12, 56, 15);
		panel_2.add(lblOptions);
		
		JPanel panel_2_0 = new JPanel();
		panel_2_0.setBorder(new BevelBorder(BevelBorder.LOWERED, null, null, null, null));
		panel_2_0.setBounds(0, 35, 277, 100);
		panel_2.add(panel_2_0);
		panel_2_0.setLayout(null);
		
		JLabel lblNumberOfThreads = new JLabel("Number of Threads: ");
		lblNumberOfThreads.setBounds(12, 12, 181, 15);
		panel_2_0.add(lblNumberOfThreads);
		
		JComboBox comboBox = new JComboBox(new DefaultComboBoxModel(new String[] {"1", "2", "4"}));
		comboBox.setBounds(12, 39, 83, 24);
		comboBox.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent arg0) {
				JComboBox cb = (JComboBox) arg0.getSource();
				
				threadCount = Integer.valueOf(cb.getSelectedItem().toString());
			}
		});
		panel_2_0.add(comboBox);
		
		JPanel panel_2_1 = new JPanel();
		panel_2_1.setLayout(null);
		panel_2_1.setBorder(new BevelBorder(BevelBorder.LOWERED, null, null, null, null));
		panel_2_1.setBounds(0, 140, 277, 100);
		panel_2.add(panel_2_1);
		
		JLabel lblSaveResults = new JLabel("Save Results: ");
		lblSaveResults.setBounds(12, 12, 161, 15);
		panel_2_1.add(lblSaveResults);
		
		saveResultsField = new JTextField();
		saveResultsField.setBounds(98, 39, 167, 19);
		saveResultsField.setColumns(10);
		panel_2_1.add(saveResultsField);
		
		btnApply = new JButton("apply");
		btnApply.setBounds(12, 37, 73, 25);
		btnApply.addActionListener(this);
		panel_2_1.add(btnApply);
		
		btnStartCracking = new JButton("Start Cracking!");
		btnStartCracking.setBackground(Color.GREEN);
		btnStartCracking.setBounds(12, 428, 253, 25);
		btnStartCracking.addActionListener(this);
		panel_2.add(btnStartCracking);
		
		JPanel panel_2_2 = new JPanel();
		panel_2_2.setLayout(null);
		panel_2_2.setBorder(new BevelBorder(BevelBorder.LOWERED, null, null, null, null));
		panel_2_2.setBounds(0, 245, 277, 159);
		panel_2.add(panel_2_2);
		
		JLabel lblMcVersion = new JLabel("MC Version:");
		lblMcVersion.setBounds(12, 0, 125, 30);
		panel_2_2.add(lblMcVersion);
		
		JComboBox comboBoxMcVersion = new JComboBox(new DefaultComboBoxModel(new String[] {"1.12.2", "1.16.5"}));
		comboBoxMcVersion.setBounds(155, 3, 110, 24);
		comboBoxMcVersion.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent arg0) {
				JComboBox cb = (JComboBox) arg0.getSource();
				
				if(cb.getSelectedItem().toString() == "1.16.5") mcVersion = EnumMCVersion.V1_16_5;
				if(cb.getSelectedItem().toString() == "1.12.2") mcVersion = EnumMCVersion.V1_12_2;
			}
		});
		panel_2_2.add(comboBoxMcVersion);
		
		JLabel lblLockDirection = new JLabel("Lock direction:");
		lblLockDirection.setBounds(12, 30, 125, 30);
		panel_2_2.add(lblLockDirection);
		
		JComboBox comboBoxDirection = new JComboBox(new DefaultComboBoxModel(new String[] {"unset", "north", "east", "south", "west"}));
		comboBoxDirection.setBounds(155, 34, 110, 24);
		comboBoxDirection.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent arg0) {
				JComboBox cb = (JComboBox) arg0.getSource();
				rotation = EnumRotation.R_ALL;
				
				if(cb.getSelectedItem().toString() == "north") rotation = EnumRotation.R0;
				if(cb.getSelectedItem().toString() == "east") rotation = EnumRotation.R90;
				if(cb.getSelectedItem().toString() == "south") rotation = EnumRotation.R180;
				if(cb.getSelectedItem().toString() == "west") rotation = EnumRotation.R270;
			}
		});
		panel_2_2.add(comboBoxDirection);
		
		JLabel yMin = new JLabel("Y minimum:");
		yMin.setBounds(12, 57, 125, 30);
		panel_2_2.add(yMin);
		
		SpinnerModel ySpinnerMinValues = new SpinnerNumberModel(this.yMin, 0, 255, 1);
		ySpinnerMin = new JSpinner(ySpinnerMinValues);
		ySpinnerMin.setBounds(155, 65, 110, 20);
		ySpinnerMin.addChangeListener(new ChangeListener() {

			@Override
			public void stateChanged(ChangeEvent arg0) {
				
				spinnerStateChangedHandler(arg0);
				
			}
			
		});
		panel_2_2.add(ySpinnerMin);
		
		JLabel yMax = new JLabel("Y maximum:");
		yMax.setBounds(12, 84, 125, 30);
		panel_2_2.add(yMax);
		
		SpinnerModel ySpinnerMaxValues = new SpinnerNumberModel(this.yMax, 1, 256, 1);
		ySpinnerMax = new JSpinner(ySpinnerMaxValues);
		ySpinnerMax.setBounds(155, 91, 110, 20);
		ySpinnerMax.addChangeListener(new ChangeListener() {

			@Override
			public void stateChanged(ChangeEvent arg0) {
				
				spinnerStateChangedHandler(arg0);
				
			}
		});
		panel_2_2.add(ySpinnerMax);
		
		JLabel bruteforceRadiusField = new JLabel("Radius:");
		bruteforceRadiusField.setBounds(12, 111, 125, 30);
		panel_2_2.add(bruteforceRadiusField);
		
		radiusTextField = new JTextField();
		radiusTextField.setBounds(155, 116, 110, 19);
		radiusTextField.setColumns(10);
		radiusTextField.setText(String.valueOf(this.radius));
		radiusTextField.getDocument().addDocumentListener(new DocumentListener() {

			@Override
			public void changedUpdate(DocumentEvent arg0) {}

			@Override
			public void insertUpdate(DocumentEvent arg0) {
				this.validateContent();
			}

			@Override
			public void removeUpdate(DocumentEvent arg0) {
				this.validateContent();
			}
			
			private void validateContent() {
				if(MathHelper.isInteger(radiusTextField.getText())) {
					int r = Integer.valueOf(radiusTextField.getText());
					
					this.removeError();
					
					if(r == 0) this.markError();
					else if(r < 0) this.markError();
					else radius = r;
					
				} else this.markError();
			}
			
			private void markError() {
				validRadius = false;
				radiusTextField.setForeground(Color.RED);
			}
			
			private void removeError() {
				validRadius = true;
				radiusTextField.setForeground(null);
			}
		});
		panel_2_2.add(radiusTextField);
		
		lblProgress = new JLabel("Progress: 0%");
		lblProgress.setBounds(12, 462, 253, 15);
		panel_2.add(lblProgress);
		
		lblTotalMatches = new JLabel("Total matches: 0");
		lblTotalMatches.setBounds(12, 482, 253, 15);
		panel_2.add(lblTotalMatches);
		
		lblEstimatetTime = new JLabel("Estimated time to completion: 0min");
		lblEstimatetTime.setBounds(12, 502, 265, 15);
		panel_2.add(lblEstimatetTime);
		
		this.renderLayer(1);
	}

	private void renderLayer(int layer) {
		layer--;
		
		for(int x = 0; x < 7; x++) {
			for(int z = 0; z < 7; z++) {	
				Vector2 currentButtonPos = new Vector2(x, z);
				Vector3 currentMatrixPos = new Vector3(x, layer, z);
				
				for(JButton b : this.fieldButtons) {
					if((b.getBounds().getX() / 50) == currentButtonPos.getX() && (b.getBounds().getY() / 50) == currentButtonPos.getZ()) {
						this.setIconNumber(b, this.pattern.getValue(currentMatrixPos));
						b.setBorder(null);
					}
				}
			}
		}
	}
	
	private void setIconNumber(JButton buttonIn, int icon) {
		if(icon == 4) {
			buttonIn.setIcon(null);
			return;
		}
		
		Image img = this.icon_0.getImage();
		if(icon == 1) {
			img = this.icon_1.getImage();
		}
		if(icon == 2) {
			img = this.icon_2.getImage();
		}
		if(icon == 3) {
			img = this.icon_3.getImage();
		}
		Image img_scaled = img.getScaledInstance(buttonIn.getWidth(), buttonIn.getHeight(), java.awt.Image.SCALE_DEFAULT);
		buttonIn.setIcon(new ImageIcon(img_scaled));
	}
	
	@Override
	public void actionPerformed(ActionEvent arg0) {
		if(arg0.getSource() instanceof JButton) {
			JButton btnIn = (JButton) arg0.getSource();
			
			if(btnIn == this.btnStartCracking) {
				if(!this.crackerRunning) {
					if(!this.crackerEnabled || !this.validRadius || !this.validYMin || !this.validYMax) return;
					
					this.crackingStart();
					
					PatternRelative p = new PatternRelative(new Vector3(7, 7, 7), new Vector3(4, 4, 4));
					for(int x = 0; x < 7; x++) {
						for(int y = 0; y < 7; y++) {
							for(int z = 0; z < 7; z++) {
								p.canAddToPattern(this.pattern.getValue(new Vector3(x, y, z)));
							}
						}
					}
					p.load();
					
					cb = new CoordinateBruteforcer(p, this.radius, this.yMin, this.yMax, this.mcVersion, this.rotation, this.getInstance(), this.threadCount);
					cb.load();
					
					return;
				}
				
				this.crackingEnd();
			}
			
			if(this.crackerRunning) return;
			
			if(btnIn == this.btnApply) {
				this.saveResultsPath = this.saveResultsField.getText();
			}
			
			if(btnIn == this.btnSetTextured) {
				for(JButton b : this.fieldButtons) {
					int posX = (int) b.getBounds().getX() / 50;
					int posZ = (int) b.getBounds().getY() / 50;
					
					if(posX == (float) this.activeField.getX() && posZ == (float) this.activeField.getZ()) {
						if(b.getIcon() != null) {
							this.pattern.setValue(new Vector3(posX, this.currentLayer - 1, posZ), 4);
							b.setIcon(null);
							return;
						}
						
						this.pattern.setValue(new Vector3(posX, this.currentLayer - 1, posZ), 0);
						this.setIconNumber(b, 0);
					}
				}
			}
			
			if(btnIn == this.btnRotateRight) {
				for(JButton b : this.fieldButtons) {
					int posX = (int) b.getBounds().getX() / 50;
					int posZ = (int) b.getBounds().getY() / 50;
					
					if(posX == (float) this.activeField.getX() && posZ == (float) this.activeField.getZ()) {
						Vector3 currentPos = new Vector3(posX, this.currentLayer - 1, posZ);
						int valueOld = this.pattern.getValue(currentPos);
						
						if(valueOld == 0) {
							this.pattern.setValue(currentPos, 1);
							this.setIconNumber(b, 1);
						}
						else if(valueOld == 1) {
							this.pattern.setValue(currentPos, 2);
							this.setIconNumber(b, 2);
						}
						else if(valueOld == 2) {
							this.pattern.setValue(currentPos, 3);
							this.setIconNumber(b, 3);
						}
						else if(valueOld == 3) {
							this.pattern.setValue(currentPos, 0);
							this.setIconNumber(b, 0);
						}
					}
				}
			}
			
			for(JButton b : this.fieldButtons) {
				if(b == btnIn) {
					int posX = (int) btnIn.getBounds().getX() / 50;
					int posZ = (int) btnIn.getBounds().getY() / 50;
					
					this.activeField.setX(posX);
					this.activeField.setZ(posZ);
				}
			}
		}
	}
	
	private void spinnerStateChangedHandler(ChangeEvent arg0) {
		if(arg0.getSource() instanceof JSpinner) {
			JSpinner jsp = (JSpinner) arg0.getSource();
			
			ySpinnerMax.getEditor().getComponent(0).setForeground(null);
			ySpinnerMin.getEditor().getComponent(0).setForeground(null);
			
			if(jsp == ySpinnerMin) {
				this.validYMin = true;
				if(Integer.valueOf(jsp.getValue().toString()) >= Integer.valueOf(ySpinnerMax.getValue().toString())) {
					jsp.getEditor().getComponent(0).setForeground(Color.RED);
					ySpinnerMax.getEditor().getComponent(0).setForeground(Color.RED);
					this.validYMin = false;
				} else this.yMin = Integer.valueOf(jsp.getValue().toString());
			}
			
			if(jsp == ySpinnerMax) {
				this.validYMax = true;
				if(Integer.valueOf(jsp.getValue().toString()) <= Integer.valueOf(ySpinnerMin.getValue().toString())) {
					jsp.getEditor().getComponent(0).setForeground(Color.RED);
					ySpinnerMin.getEditor().getComponent(0).setForeground(Color.RED);
					this.validYMax = false;
				} else this.yMax = Integer.valueOf(jsp.getValue().toString());
			}	
		}
	}

	public Main getInstance() {
		return instance;
	}
	
	public void crackingStart() {
		this.initializeSaveFile();
		
		this.lblProgress.setText("Progress: 0%");
		this.lblTotalMatches.setText("Total matches: 0");
		this.lblEstimatetTime.setText("Estimated time to completion: calculating...");
		
		this.btnStartCracking.setText("Running...");
		this.btnStartCracking.setBackground(Color.RED);
		this.crackerRunning = true;
	}
	
	public void crackingEnd() {
		System.out.println("Cracking end");
		
		try{cb.veryVeryBadTermination();} catch(Exception e) {}
		this.btnStartCracking.setText("Start Cracking!");
		this.btnStartCracking.setBackground(Color.GREEN);
		this.crackerRunning = false;
	}
	
	public void updateMatchesCount(int matches) {
		this.lblTotalMatches.setText("Total matches: " + matches);
	}
	
	public int getThreadCount() {
		return this.threadCount;
	}
	
	public void initializeSaveFile() {
		if(this.saveResultsPath != null && this.saveResultsPath != "") this.saveResultsPath += (this.saveResultsPath.endsWith(".txt") ? "" : ".txt");
		else {
			DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy-MM-dd:HH-mm-ss");
			LocalDateTime now = LocalDateTime.now();
			
			this.saveResultsPath = "coordinates_" + dtf.format(now) + ".txt";
		}
	}
	
	public String getSaveFile() {
		return this.saveResultsPath;
	}
}
